from typing import List, Optional
from sqlalchemy.ext.asyncio import AsyncSession

from repositories.vulnerability_repository import VulnerabilityRepository
from schemas.vulnerability import Vulnerability, VulnerabilityUpdate
from models.enums import VulnerabilitySeverity


class VulnerabilityService:
    """
    Сервис для работы с уязвимостями
    Обеспечивает бизнес-логику для операций с уязвимостями
    """

    def __init__(self, session: AsyncSession):
        self.repository = VulnerabilityRepository(session)
        self.session = session

    async def get_all(
        self,
        device_id: Optional[int] = None,
        severity: Optional[VulnerabilitySeverity] = None,
        skip: int = 0,
        limit: int = 100,
    ) -> List[Vulnerability]:
        """
        Получить все уязвимости с фильтрацией

        Args:
                device_id: ID устройства (опционально)
                severity: Уровень критичности (опционально)
                skip: Количество записей для пропуска
                limit: Максимальное количество записей

        Returns:
                Список уязвимостей
        """
        vulnerabilities = await self.repository.get_filtered(
            device_id=device_id,
            severity=severity,
            skip=skip,
            limit=limit,
        )
        return [Vulnerability.model_validate(vuln) for vuln in vulnerabilities]

    async def get_by_id(
        self, vulnerability_id: int
    ) -> Optional[Vulnerability]:
        """
        Получить уязвимость по ID

        Args:
                vulnerability_id: ID уязвимости

        Returns:
                Уязвимость или None
        """
        vulnerability = await self.repository.get_by_id(vulnerability_id)
        if not vulnerability:
            return None
        return Vulnerability.model_validate(vulnerability)

    async def update(
        self, vulnerability_id: int, update_data: VulnerabilityUpdate
    ) -> Optional[Vulnerability]:
        """
        Обновить уязвимость

        Args:
                vulnerability_id: ID уязвимости
                update_data: Данные для обновления

        Returns:
                Обновленная уязвимость или None
        """
        update_dict = update_data.model_dump(exclude_unset=True)
        vulnerability = await self.repository.update(
            vulnerability_id, **update_dict
        )
        if not vulnerability:
            return None
        return Vulnerability.model_validate(vulnerability)

